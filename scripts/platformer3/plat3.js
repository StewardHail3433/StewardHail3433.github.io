var X=Object.defineProperty;var C=h=>{throw TypeError(h)};var N=(h,t,e)=>t in h?X(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var m=(h,t,e)=>N(h,typeof t!="symbol"?t+"":t,e),E=(h,t,e)=>t.has(h)||C("Cannot "+e);var j=(h,t,e)=>(E(h,t,"read from private field"),e?e.call(h):t.get(h)),w=(h,t,e)=>t.has(h)?C("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(h):t.set(h,e),R=(h,t,e,s)=>(E(h,t,"write to private field"),s?s.call(h,e):t.set(h,e),e);const r={canvasScale:2,movementScale:100};class Y{constructor(t,e,s,i,a,o){this.canvasUI=document.createElement("canvas"),this.canvasUI.width=t.canvas.width,this.canvasUI.height=t.canvas.height,this.ctxUI=this.canvasUI.getContext("2d"),this.toggles={showUI:!0,showDevUI:!1},this.enemies=i,this.devValues={speed:{name:"speed",getter:()=>e.speed/r.movementScale,setter:l=>e.speed=l*r.movementScale,editable:!0,focus:!1},gravity:{name:"gravity",getter:()=>e.gravity/r.movementScale,setter:l=>e.gravity=l*r.movementScale,increment:.05,editable:!0,focus:!1},liquidGravity:{name:"liquidGravity",getter:()=>e.liquidGravity/r.movementScale,setter:l=>e.liquidGravity=l*r.movementScale,increment:.2,editable:!0,focus:!1},jumpSpeed:{name:"jumpSpeed",getter:()=>e.jumpSpeed/r.movementScale,setter:l=>e.jumpSpeed=l*r.movementScale,editable:!0,focus:!1},width:{name:"width",getter:()=>e.width,setter:l=>e.width=l,editable:!1,focus:!1},height:{name:"height",getter:()=>e.height,setter:l=>e.height=l,editable:!1,focus:!1},x:{name:"x",getter:()=>e.pos.x,setter:l=>e.pos.x=l,editable:!1,focus:!1},y:{name:"y",getter:()=>e.pos.y,setter:l=>e.pos.y=l,editable:!0,focus:!1,increment:100},alive:{name:"alive",getter:()=>e.alive,setter:l=>e.alive=l,editable:!0,focus:!1,boolean:!0},noDeathMode:{name:"noDeathMode",getter:()=>e.noDeathMode,setter:l=>e.noDeathMode=l,editable:!0,focus:!1,boolean:!0},noEnemyDeath:{name:"noEnemyDeath",getter:()=>this.enemies.length>0&&this.enemies[0].noEnemyDeath,setter:l=>{for(const d of this.enemies)d.noEnemyDeath=l},editable:!0,focus:!1,boolean:!0}},this.devRect={width:t.canvas.width*(1/8),height:t.canvas.height,x:t.canvas.width-t.canvas.width*(1/8),y:0,ySpacing:t.canvas.width*(1/8)/12.8*2,fontSize:t.canvas.width*(1/8)/12.8},this.pauseRect={width:this.ctxUI.canvas.width*(8/10),height:this.ctxUI.canvas.height*(8/10),x:this.ctxUI.canvas.width*(1/10),y:this.ctxUI.canvas.height*(1/10),ySpacing:t.canvas.width*(8/10)/20.48,fontSize:t.canvas.height*(8/10)/21.04,buttons:{width:this.ctxUI.canvas.width*(8/10)*(3/10),height:this.ctxUI.canvas.height*(8/10)*(1/20)}},this.sound=o,this.pauseMenuButtons={return:{name:"Return Back"},sound:{name:"Sounds",slider:{music:{name:"Music",getter:()=>this.sound.getVolume("music"),setter:l=>{this.sound.setVolume("music",l)}},sfx:{name:"SFX",getter:()=>this.sound.getVolume("sfx"),setter:l=>{this.sound.setVolume("sfx",l)}}}}},this.ctxMain=t,this.player=e,this.camera=s,this.state=a,this.pauseState="none"}update(t){this.state=t,t==="pause"&&this.pauseState==="none"&&(this.pauseState="main"),this.toggles.showDevUI&&this.updateDEV()}updateDEV(){for(var t in this.devValues)this.devValues.hasOwnProperty(t)&&(this.devValues[t].value=this.devValues[t].getter())}render(){this.toggles.showUI&&(this.ctxUI.clearRect(0,0,this.canvasUI.width,this.canvasUI.height),this.ctxUI.fillStyle="rgba(255, 0, 255, 1)",this.ctxUI.fillRect(0,0,16,16),this.state==="pause"&&this.renderPause(),this.toggles.showDevUI&&this.renderDEV(),this.player.alive||this.renderDeath(),this.ctxMain.drawImage(this.canvasUI,0,0,this.ctxMain.canvas.width,this.ctxMain.canvas.height))}renderPause(){this.ctxUI.fillStyle="rgba(0, 0, 158, 0.5)",this.ctxUI.font=this.pauseRect.fontSize+"px sans-serif",this.ctxUI.fillRect(this.pauseRect.x,this.pauseRect.y,this.pauseRect.width,this.pauseRect.height);let t=this.pauseRect.y;if(this.ctxUI.fillStyle="rgba(0, 255, 0, 1)",this.pauseState==="main"){for(var e in this.pauseMenuButtons)if(this.pauseMenuButtons.hasOwnProperty(e)){t+=this.pauseRect.ySpacing,this.ctxUI.font=this.pauseRect.fontSize+"px sans-serif";var s=this.pauseMenuButtons[e].name,i=this.ctxUI.measureText(s).width;let a=this.ctxUI.canvas.width*(1/10)+this.ctxUI.canvas.width*(8/10)/2-i/2,o=this.ctxUI.canvas.width/2-this.pauseRect.buttons.width/2;this.ctxUI.fillStyle="rgba(189, 195, 199, 0.5)",this.ctxUI.fillRect(o,t-this.pauseRect.fontSize,this.pauseRect.buttons.width,this.pauseRect.buttons.height),this.ctxUI.fillStyle="rgba(200, 235, 239, 0.5)",this.ctxUI.fillText(s,a,t)}}if(this.pauseState===this.pauseMenuButtons.sound.name){for(var e in this.pauseMenuButtons.sound)if(this.pauseMenuButtons.sound.hasOwnProperty(e)&&this.pauseMenuButtons.sound.name!=this.pauseMenuButtons.sound[e]&&this.pauseMenuButtons.sound.slider!=null)for(var e in this.pauseMenuButtons.sound.slider){t+=this.pauseRect.ySpacing,this.ctxUI.font=this.pauseRect.fontSize+"px sans-serif";var s=this.pauseMenuButtons.sound.slider[e].name+": "+this.pauseMenuButtons.sound.slider[e].getter(),i=this.ctxUI.measureText(s).width;let k=this.ctxUI.canvas.width*(1/10)+this.ctxUI.canvas.width*(8/10)/2-i/2,U=this.ctxUI.canvas.width/2-this.pauseRect.buttons.width/2;this.ctxUI.fillStyle="rgba(189, 195, 199, 0.5)",this.ctxUI.fillRect(U,t-this.pauseRect.fontSize,this.pauseRect.buttons.width,this.pauseRect.buttons.height),this.ctxUI.fillStyle="rgba(255, 255, 255, 0.5)";let O=2,G=U+this.pauseRect.buttons.width-U,q=(this.pauseMenuButtons.sound.slider[e].getter()-0)*G/O+U;this.ctxUI.fillRect(q,t-this.pauseRect.fontSize,this.pauseRect.buttons.width/20,this.pauseRect.buttons.height*1),this.ctxUI.fillStyle="rgba(0, 0, 0, 0.5)",this.ctxUI.fillText(s,k,t)}}}renderDeath(){this.ctxUI.fillStyle="rgba(255, 255, 255, 1)",this.ctxUI.font="20px sans-serif";let t=this.ctxMain.canvas.height/2-10;var e="YOU DIED",s=this.ctxUI.measureText(e).width;let i=this.ctxMain.canvas.width/2-s/2;this.ctxUI.fillText(e,i,t)}renderDEV(){this.camera.render();for(let a=0;a<this.enemies.length;a++)this.enemies[a].renderDev();this.ctxUI.fillStyle="rgba(0, 0, 0, 0.25)",this.ctxUI.fillRect(this.devRect.x,this.devRect.y,this.devRect.width,this.devRect.height);let t=0;for(var e in this.devValues)if(this.devValues.hasOwnProperty(e)){t+=this.devRect.ySpacing,this.devValues[e].editable?(this.ctxUI.fillStyle="rgba(255, 0, 0, 1)",this.devValues[e].focus&&(this.ctxUI.fillStyle="rgba(0, 0, 255, 1)")):this.ctxUI.fillStyle="rgba(255, 255, 255, 1)",this.ctxUI.font=this.devRect.fontSize+"px sans-serif";var s=this.devValues[e].name+": "+this.devValues[e].value,i=this.ctxUI.measureText(s).width;let a=this.devRect.x+this.devRect.width/2-i/2;this.ctxUI.fillText(s,a,t),this.ctxUI.fillStyle="rgba(0, 255, 0, 1)",this.ctxUI.strokeRect(a,t-this.devRect.fontSize,i,this.devRect.fontSize)}}keyDownInput(t){if(t==="F1"){if(this.toggles.showUI){this.toggles.showUI=!1;return}if(!this.toggles.showUI){this.toggles.showUI=!0;return}}if(t==="F3"){if(this.toggles.showDevUI){this.toggles.showDevUI=!1;return}if(!this.toggles.showDevUI){this.toggles.showDevUI=!0;return}}this.toggles.showDevUI&&this.keyDownInputDEV(t)}keyDownInputDEV(t){for(var e in this.devValues)this.devValues[e].focus&&(this.devValues[e].increment!=null?(t==="ArrowRight"&&this.devValues[e].setter(this.devValues[e].getter()+this.devValues[e].increment),t==="ArrowLeft"&&this.devValues[e].setter(this.devValues[e].getter()-this.devValues[e].increment)):this.devValues[e].boolean?(t==="ArrowRight"&&this.devValues[e].setter(!this.devValues[e].getter()),t==="ArrowLeft"&&this.devValues[e].setter(!this.devValues[e].getter())):(t==="ArrowRight"&&this.devValues[e].setter(this.devValues[e].getter()+1),t==="ArrowLeft"&&this.devValues[e].setter(this.devValues[e].getter()-1)))}onClickInput(t){this.onClickInputMenu(t),this.toggles.showDevUI&&this.onClickInputDEV(t)}onClickInputDEV(t){var e=this.ctxMain.canvas.getBoundingClientRect(),s={x:t.clientX-e.left,y:t.clientY-e.top};if(this.state=="play"){let l=0;for(var i in this.devValues)if(this.devValues.hasOwnProperty(i)){l+=this.devRect.ySpacing,this.ctxUI.font=this.devRect.fontSize+"px sans-serif";var a=this.devValues[i].name+": "+this.devValues[i].value,o=this.ctxUI.measureText(a).width;let d=this.devRect.x+this.devRect.width/2-o/2;s.x>=d&&s.x<=d+o&&s.y>=l-this.devRect.fontSize&&s.y<=l&&this.devValues[i].editable?this.devValues[i].focus=!0:this.devValues[i].focus=!1}}}onMouseUp(t){this.dragging=!1}onClickInputMenu(t){var e=this.ctxMain.canvas.getBoundingClientRect(),s={x:t.clientX-e.left,y:t.clientY-e.top};if(this.state=="pause"){let a=this.pauseRect.y;if(this.pauseState=="main"){for(var i in this.pauseMenuButtons)if(this.pauseMenuButtons.hasOwnProperty(i)){a+=this.pauseRect.ySpacing;let o=this.ctxUI.canvas.width/2-this.pauseRect.buttons.width/2;s.x>=o&&s.x<=o+this.pauseRect.buttons.width&&s.y>=a-this.pauseRect.fontSize&&s.y<=a&&(this.pauseState=this.pauseMenuButtons[i].name,this.pauseState==this.pauseMenuButtons.return.name&&(this.pauseState="change to play"))}}if(this.pauseState==this.pauseMenuButtons.sound.name){for(var i in this.pauseMenuButtons.sound.slider)if(this.pauseMenuButtons.sound.slider.hasOwnProperty(i)){a+=this.pauseRect.ySpacing;let l=this.ctxUI.canvas.width/2-this.pauseRect.buttons.width/2;if(s.x>=l&&s.x<=l+this.pauseRect.buttons.width&&s.y>=a-this.pauseRect.buttons.height&&s.y<=a){let d=2,k=l+this.pauseRect.buttons.width-l;this.pauseMenuButtons.sound.slider[i].setter(Math.round(((s.x-l)*d/k+0+Number.EPSILON)*100)/100)}}}}}}function u(h,t){return h.pos.y+h.height>=t.pos.y&&h.pos.y<=t.pos.y+t.height&&h.pos.x<=t.pos.x+t.width&&h.pos.x+h.width>=t.pos.x}class F{constructor(t,e,s){this.width=10,this.height=29,this.pos={x:-1e3,y:0},this.vel={x:0,y:1},this.keys={w:!1,a:!1,s:!1,d:!1},this.speed=1*r.movementScale,this.gravity=5*r.movementScale,this.liquidGravity=3.5*r.movementScale,this.jumpSpeed=3*r.movementScale,this.ctx=t,this.grounded=!1,this.map=e,this.camera=s,this.alive=!0,this.noDeathMode=!1,this.inLiquid=!1,this.inClimbable=!1,this.img=new Image,this.img.src="./resources/plat3/entities/player/playerIdle0.png",this.currentAnimation="None",this.currentFrameIndex=0,this.animationTimer=0,this.frameDuration=250}update(t,e){this.alive&&this.move(t),this.collisionOnX(),this.applyGravity(t),this.collisionOnY(),this.noDeathMode||this.checkEnemiesDeath(e),this.animationTimer+=t*1e3,this.vel.x==0&&this.currentAnimation!="idle"?this.currentAnimation="idle":this.vel.x!==0&&this.currentAnimation!="walk"&&(this.currentFrameIndex=0,this.currentAnimation="walk")}render(){this.ctx.fillStyle="blue",this.animationTimer>=this.frameDuration&&(this.animationTimer=0,this.currentFrameIndex=(this.currentFrameIndex+1)%(this.img.width/this.width)),this.currentAnimation=="idle"?this.img.src="./resources/plat3/entities/player/playerIdle0.png":this.currentAnimation=="walk"&&(this.img.src="./resources/plat3/entities/player/playerWalk.png"),this.ctx.drawImage(this.img,this.currentFrameIndex*this.width,0,this.width,this.height,this.pos.x,this.pos.y,this.width,this.height)}move(t){this.keys.a&&this.keys.d?this.vel.x=0:this.keys.a?this.vel.x=-this.speed:this.keys.d?this.vel.x=this.speed:this.vel.x=0,this.inLiquid?this.keys.w&&this.keys.s?this.vel.y=0:this.keys.w?this.vel.y=-this.speed:this.keys.s&&(this.vel.y=this.speed):(this.keys.w&&(this.grounded||this.inClimbable)&&this.vel.y===0&&(this.vel.y=-this.jumpSpeed,this.grounded=!1),this.keys.s&&this.inClimbable&&(this.vel.y=this.jumpSpeed),!this.keys.w&&!this.keys.s&&this.inClimbable&&(this.vel.y=0)),this.pos.x+=this.vel.x*t}keyDownInput(t){t==="a"&&(this.keys.a=!0),t==="d"&&(this.keys.d=!0),(t==="w"||t==="ArrowUp"||t===" "&&this.grounded==!0&&this.vel.y==0)&&(this.keys.w=!0),t==="s"&&(this.keys.s=!0)}keyUpInput(t){t==="a"&&(this.keys.a=!1),t==="d"&&(this.keys.d=!1),(t==="w"||t==="ArrowUp"||t===" ")&&(this.keys.w=!1),t==="s"&&(this.keys.s=!1)}collisionOnY(){let t=!1;for(let e=0;e<this.map.length;e++){for(let s=0;s<this.map[e].length;s++){let i=this.map[e][s];if(i.collision&&u(this,i)){if(this.vel.y>0){this.vel.y=0,this.pos.y=i.pos.y-this.height-.01,this.grounded=!0,t=!0;break}if(this.vel.y<0){this.vel.y=0,this.pos.y=i.pos.y+i.height+.01,t=!0;break}}}if(t)break}this.pos.y+this.height>=this.ctx.canvas.height&&(this.vel.y=0,this.pos.y=this.ctx.canvas.height-this.height,this.grounded=!0)}collisionOnX(){let t=!1;for(let e=0;e<this.map.length;e++){for(let s=0;s<this.map[e].length;s++){let i=this.map[e][s];if(i.collision&&u(this,i)){if(this.vel.x>0){this.vel.x=0,this.pos.x=i.pos.x-this.width-.01,t=!0;break}if(this.vel.x<0){this.vel.x=0,this.pos.x=i.pos.x+i.width+.01,t=!0;break}}}if(t)break}}checkEnemiesDeath(t){for(let e=0;e<t.length;e++)if(u(this,t[e])&&this.pos.y+this.height>t[e].pos.y+t[e].height/2&&(this.alive=!1),t[e].projectileEnemy)for(let s=0;s<t[e].projectile.length;s++)u(this,t[e].projectile[s])&&(t[e].projectile[s].delete=!0,this.alive=!1)}applyGravity(t){let e=!0;for(let s=0;s<this.map.length;s++){for(let i=0;i<this.map[s].length;i++){let a=this.map[s][i];if(u(this,a)&&a.isClimbable){e=!1,this.inClimbable=!0;break}else this.inClimbable=!1}if(e==!1)break}if(e){this.vel.y+=this.gravity*t;let s=!1;for(let i=0;i<this.map.length;i++){for(let a=0;a<this.map[i].length;a++){let o=this.map[i][a];if(u(this,o)&&o.isLiquid){this.vel.y-=this.gravity*t,this.vel.y+=this.liquidGravity*t,this.vel.y>2*r.movementScale&&(this.vel.y=2*r.movementScale),s=!0,this.inLiquid=!0;break}else this.inLiquid=!1}if(s)break}}this.pos.y+=this.vel.y*t}}var I,D,b;class L{constructor(t){m(this,"pos",{x:0,y:0});m(this,"width",0);m(this,"height",0);w(this,I);w(this,D);w(this,b,!1);m(this,"shouldRender",!1);m(this,"img");m(this,"isLiquid",!1);m(this,"isClimbable",!1);R(this,D,t)}get width(){return this.width}get height(){return this.height}get value(){return j(this,I)}get collision(){return j(this,b)}get pos(){return this.pos}set value(t){R(this,I,t)}set collision(t){R(this,b,t)}}I=new WeakMap,D=new WeakMap,b=new WeakMap;class W{constructor(t){this.tileSize=t,this.images={}}preloadImages(t){const e=Object.entries(t).map(([s,i])=>new Promise((a,o)=>{const l=new Image(this.tileSize,this.tileSize);l.src=i,l.onload=()=>{this.images[s]=l,a()},l.onerror=()=>{console.error(`Failed to load image: ${i}`),o(`Failed to load image: ${i}`)}}));return Promise.all(e)}getImage(t){return this.images[t]||null}}var V;class H{constructor(t,e,s){m(this,"map",[]);m(this,"ctx");w(this,V,.25);this.ctx=t,this.tileSize=32,console.log(this.tileSize),this.yOffset=Math.floor(this.tileSize),this.camera=e,this.player=s,this.showMini=!1,this.tileImageLoader=new W(this.tileSize);const i={grass1Side:"./resources/plat3/tiles/grass/grass1Side.png",grassCorner:"./resources/plat3/tiles/grass/grassCorner.png",grass3Sides:"./resources/plat3/tiles/grass/grass3Sides.png",grass4Sides:"./resources/plat3/tiles/grass/grass4Sides.png",grassSurrounded:"./resources/plat3/tiles/grass/grass1Side.png",dirt:"./resources/plat3/tiles/dirt.png",ladder:"./resources/plat3/tiles/ladder.png",water:"./resources/plat3/tiles/water.png"};this.tileImageLoader.preloadImages(i).then(()=>{console.log("All images preloaded"),this.loadMap()}).catch(a=>console.error(a))}loadMap(){fetch("./resources/plat3/level/level1.txt").then(t=>t.text()).then(t=>{let e=t.trim().split(`
`);for(let s=0;s<e.length;s++){this.map[s]=[];let i=e.length*-this.tileSize+this.ctx.canvas.height;for(let a=0;a<e[s].split(" ").length;a++)this.map[s][a]=new L(this.ctx),this.map[s][a].value=parseInt(e[s].split(" ")[a]),this.map[s][a].pos.x=a*this.tileSize,this.map[s][a].pos.y=i+s*this.tileSize,this.map[s][a].width=this.tileSize,this.map[s][a].height=this.tileSize,this.map[s][a].img=new Image(this.tileSize,this.tileSize),this.setTileData(this.map[s][a],s,a,e)}this.camera.setMapSize(this.map[0].length*this.tileSize,this.map.length*this.tileSize),console.log(this.map)}).catch(t=>console.error(t))}rotateImage(t,e){const s=document.createElement("canvas"),i=s.getContext("2d");s.width=this.tileSize,s.height=this.tileSize,i.translate(s.width/2,s.height/2),i.rotate(e*Math.PI/180),i.drawImage(t,-this.tileSize/2,-this.tileSize/2,this.tileSize,this.tileSize);const a=new Image(this.tileSize,this.tileSize);return a.src=s.toDataURL(),a}setTileData(t,e,s,i){if(t.value===1){t.img=this.tileImageLoader.getImage("dirt");const a=e>0?this.map[e-1][s].value:0,o=e<i.length-1?parseInt(i[e+1].split(" ")[s]):0,l=s>0?this.map[e][s-1].value:0,d=s<i[e].split(" ").length-1?parseInt(i[e].split(" ")[s+1]):0;a===0&&l===0&&d===0&&o===0?t.img=this.tileImageLoader.getImage("grass4Sides"):o===0&&l===0&&d===0?t.img=this.tileImageLoader.getImage("grass3Sides"):o===0&&l===0&&a===0?t.img=this.rotateImage(this.tileImageLoader.getImage("grass3Sides"),90):a===0&&l===0&&d===0?t.img=this.rotateImage(this.tileImageLoader.getImage("grass3Sides"),180):o===0&&a===0&&d===0?t.img=this.rotateImage(this.tileImageLoader.getImage("grass3Sides"),270):a===0&&d===0?t.img=this.tileImageLoader.getImage("grassCorner"):o===0&&d===0?t.img=this.rotateImage(this.tileImageLoader.getImage("grassCorner"),90):o===0&&l===0?t.img=this.rotateImage(this.tileImageLoader.getImage("grassCorner"),180):a===0&&l===0?t.img=this.rotateImage(this.tileImageLoader.getImage("grassCorner"),270):a===0?t.img=this.tileImageLoader.getImage("grass1Side"):l===0?t.img=this.rotateImage(this.tileImageLoader.getImage("grass1Side"),270):d===0?t.img=this.rotateImage(this.tileImageLoader.getImage("grass1Side"),90):o===0&&(t.img=this.rotateImage(this.tileImageLoader.getImage("grass1Side"),180)),t.collision=!0}else t.value===2?t.img=this.tileImageLoader.getImage("dirt"):t.value===3?(t.img=this.tileImageLoader.getImage("ladder"),t.isClimbable=!0):t.value===4?(t.img=this.tileImageLoader.getImage("water"),t.isLiquid=!0):t.value===5?(t.img=this.tileImageLoader.getImage("lava"),t.isLiquid=!0):t.collision=!1}setlevel(t){fetch("./resources/plat3/level/"+t+".txt").then(e=>e.text()).then(e=>{let s=e.trim().split(`
`);for(let i=0;i<s.length;i++){this.map[i]=[];let a=s.length*-this.tileSize+this.ctx.canvas.height;for(let o=0;o<s[i].split(" ").length;o++)this.map[i][o]=new L(this.ctx),this.map[i][o].value=parseInt(s[i].split(" ")[o]),this.map[i][o].pos.x=o*this.tileSize,this.map[i][o].pos.y=a+i*this.tileSize,this.map[i][o].width=this.tileSize,this.map[i][o].height=this.tileSize,this.map[i][o].img=new Image(this.tileSize,this.tileSize),this.setTileData(this.map[i][o],i,o,s)}this.camera.setMapSize(this.map[0].length*this.tileSize,this.map.length*this.tileSize),console.log(this.map)}).catch(e=>console.error(e))}render(){for(let t=0;t<this.map.length;t++)for(let e=0;e<this.map[t].length;e++){let s=this.map[t][e];if(s.shouldRender){this.ctx.beginPath();try{this.ctx.drawImage(s.img,s.pos.x,s.pos.y,this.tileSize,this.tileSize)}catch(i){console.error(s.img.src+`
`+i)}s.value==1?this.ctx.fillStyle="green":s.value==2?this.ctx.fillStyle="brown":s.value==3?this.ctx.fillStyle="BurlyWood":s.value==4?this.ctx.fillStyle="navy":this.ctx.fillStyle="black",this.ctx.fill(),this.ctx.closePath()}}}update(t){for(let e=0;e<this.map.length;e++)for(let s=0;s<this.map[e].length;s++){let i=this.map[e][s];i.shouldRender=!1,this.camera.shouldRender(i)&&(i.shouldRender=!0)}}keyDownInput(t){t==="m"&&(this.showMini=!this.showMini)}get map(){return this.map}}V=new WeakMap;class ${constructor(t){this.pos={x:0,y:0},this.ctx=t,this.width=this.ctx.canvas.width/r.canvasScale,this.height=this.ctx.canvas.height/r.canvasScale,this.target=null,this.mapWidth,this.mapWidth,this.leftBoundary=!1,this.rightBoundary=!1,this.topBoundary=!1,this.bottomBoundary=!1}setMapSize(t,e){this.mapWidth=t,this.mapHeight=e}setTarget(t){this.target=t}render(){this.ctx.fillStyle="rgba(255, 0, 0, 0.2)",this.ctx.fillRect(this.pos.x,this.pos.y,this.width,this.height)}update(){this.target!=null&&(this.pos={x:this.target.pos.x+this.target.width/2-this.width/2,y:this.target.pos.y+this.target.height/2-this.height*2/3}),this.checkBoundaries()}checkBoundaries(){this.pos.x+this.width>=this.mapWidth?(this.pos.x=this.mapWidth-this.width-.01,this.rightBoundary=!0):this.rightBoundary=!1,this.pos.x<=0?(this.pos.x=.01,this.leftBoundary=!0):this.leftBoundary=!1,this.pos.y+this.height>=this.ctx.canvas.height?(this.pos.y=this.ctx.canvas.height-this.height-.01,this.bottomBoundary=!0):this.bottomBoundary=!1,this.pos.y<=this.ctx.canvas.height-this.mapHeight?(this.pos.y=this.ctx.canvas.height-this.mapHeight+.01,this.topBoundary=!0):this.topBoundary=!1}shouldRender(t){let e=!1;return u(this,t)&&(e=!0),e}}class J{constructor(t,e,s,i,a,o){this.width=10,this.height=20,this.pos={x:0,y:-500},this.vel={x:0,y:1},this.speed=1*r.movementScale,this.gravity=5*r.movementScale,this.jumpSpeed=3*r.movementScale,this.ctx=t,this.grounded=!1,this.map=e,this.direction="left",this.camera=s,this.projectileEnemy=!1,this.player=i,this.jumpChance=1e3,this.index=o,this.shouldDelete=!1,this.noEnemyDeath=!1,this.volMultiplier=0,this.sound=a}update(t){if(!this.noEnemyDeath&&u(this,this.player)&&this.player.pos.y+this.player.height>=this.pos.y&&this.player.pos.y+this.player.height<=this.pos.y+this.height*.125){this.sound.play("sfx",0),this.player.vel.y=-2*r.movementScale,this.shouldDelete=!0;return}this.move(t),this.collisionOnX(),this.applyGravity(t),this.collisionOnY()}render(){this.ctx.fillStyle="red",this.ctx.fillRect(this.pos.x,this.pos.y,this.width,this.height)}renderDev(){}move(t){this.direction=="left"?this.vel.x=-this.speed:this.direction=="right"?this.vel.x=this.speed:this.vel.x=0,Math.floor(Math.random()*this.jumpChance)==this.jumpChance-1&&this.grounded&&this.vel.y===0&&(this.vel.y=-this.jumpSpeed,this.grounded=!1),this.pos.x+=this.vel.x*t}collisionOnY(){let t=!1;for(let e=0;e<this.map.length;e++){for(let s=0;s<this.map[e].length;s++){let i=this.map[e][s];if(i.collision&&u(this,i)){if(this.vel.y>0){this.vel.y=0,this.pos.y=i.pos.y-this.height-.01,this.grounded=!0,t=!0;break}if(this.vel.y<0){this.vel.y=0,this.pos.y=i.pos.y+i.height+.01,t=!0;break}}}if(t)break}this.pos.y+this.height>=this.ctx.canvas.height&&(this.vel.y=0,this.pos.y=this.ctx.canvas.height-this.height,this.grounded=!0)}collisionOnX(){let t=!1;for(let e=0;e<this.map.length;e++){for(let s=0;s<this.map[e].length;s++){let i=this.map[e][s];if(i.collision&&u(this,i)){if(this.vel.x>0){this.vel.x=0,this.pos.x=i.pos.x-this.width-.01,t=!0;break}if(this.vel.x<0){this.vel.x=0,this.pos.x=i.pos.x+i.width+.01,t=!0;break}}}if(t)break}}applyGravity(t){this.vel.y+=this.gravity*t,this.pos.y+=this.vel.y*t}checkPlayerDeath(){if(u(this.player,this)&&this.shouldDelete&&(this.player.alive=!1),this.projectileEnemy)for(let t=0;t<this.projectile.length;t++)u(this,this.projectile[t])&&(this.player.alive=!1)}}class P extends J{constructor(t,e,s,i,a,o){super(t,e,s,i,a,o),this.pos={x:Math.floor(Math.random()*3e3),y:-500},this.speed=1*r.movementScale,this.gravity=5*r.movementScale,this.jumpSpeed=3*r.movementScale,this.direction="left"}move(t){this.direction=="left"?this.vel.x=-this.speed:this.direction=="right"?this.vel.x=this.speed:this.vel.x=0,Math.floor(Math.random()*1e3)==999&&this.grounded&&this.vel.y===0&&(this.vel.y=-this.jumpSpeed,this.grounded=!1),this.pos.x+=this.vel.x*t}collisionOnX(){let t=!1;for(let e=0;e<this.map.length;e++){for(let s=0;s<this.map[e].length;s++){let i=this.map[e][s];if(i.collision&&u(this,i)){if(this.vel.x>0){this.vel.x=0,this.pos.x=i.pos.x-this.width-.01,t=!0,this.direction="left";break}if(this.vel.x<0){this.vel.x=0,this.pos.x=i.pos.x+i.width+.01,t=!0,this.direction="right";break}}}if(t)break}}}class A{constructor(t,e,s,i,a){this.ctx=t,this.slope=e,this.pos={x:s.x,y:s.y},this.ogPos={x:s.x,y:s.y},this.vel={x:0,y:0},this.width=5,this.height=5,this.speed=1.5*r.movementScale,this.direction=i,this.delete=!1,this.index=a,i=="left"?this.vel.x=-this.speed:i=="right"&&(this.vel.x=this.speed);const o=Math.sqrt(this.vel.x**2+(this.slope*this.vel.x)**2);this.vel.x=this.vel.x/o*this.speed,this.vel.y=this.slope*this.vel.x}render(){this.ctx.fillStyle="yellow",this.ctx.fillRect(this.pos.x,this.pos.y,this.width,this.height)}update(t){this.pos.x+=this.vel.x*t,this.pos.y+=this.vel.y*t,Math.sqrt((this.pos.x-this.ogPos.x)**2+(this.pos.y-this.ogPos.y)**2)>200&&(this.delete=!0)}}class T extends P{constructor(t,e,s,i,a,o,l){super(t,e,s,i,o,l),this.pos=a,this.speed=1*r.movementScale,this.gravity=5*r.movementScale,this.jumpSpeed=3*r.movementScale,this.projectileEnemy=!0,this.aimo=5,this.projectile=[],this.lastShotElapsedTime=0}render(){this.ctx.fillStyle="purple",this.ctx.fillRect(this.pos.x,this.pos.y,this.width,this.height);for(let t=0;t<this.projectile.length;t++)this.projectile[t].render()}update(t,e){super.update(t),this.shoot(e);for(let s=0;s<this.projectile.length;s++)this.projectile[s].update(t),this.projectile[s].delete&&this.projectile.splice(s,1)}move(t){this.direction=="left"?this.vel.x=-this.speed:this.direction=="right"?this.vel.x=this.speed:this.vel.x=0,Math.floor(Math.random()*1e3)==999&&this.grounded&&this.vel.y===0&&(this.vel.y=-this.jumpSpeed,this.grounded=!1),this.pos.x+=this.vel.x*t}shoot(t){if(Math.floor(this.lastShotElapsedTime)+2<=Math.floor(t)&&this.aimo>0){let e="right";this.pos.x>this.player.pos.x&&(e="left"),this.sound.play("sfx",1),this.projectile.push(new A(this.ctx,(this.player.pos.y-this.pos.y)/(this.player.pos.x-this.pos.x),this.pos,e,this.projectile.length)),this.lastShotElapsedTime=t,this.aimo--}this.aimo==0&&Math.floor(this.lastShotElapsedTime)+4<=Math.floor(t)&&(this.aimo=5)}collisionOnY(){let t=!1;for(let e=0;e<this.map.length;e++){for(let s=0;s<this.map[e].length;s++){let i=this.map[e][s];if(i.collision&&u(this,i)){if(this.vel.y>0){this.vel.y=0,this.pos.y=i.pos.y-this.height-.01,this.grounded=!0,t=!0;break}if(this.vel.y<0){this.vel.y=0,this.pos.y=i.pos.y+i.height+.01,t=!0;break}}}if(t)break}this.pos.y+this.height>=this.ctx.canvas.height&&(this.vel.y=0,this.pos.y=this.ctx.canvas.height-this.height,this.grounded=!0)}keyUpInput(t){t==="x"&&this.shoot()}}class K extends A{constructor(t,e,s,i){super(t,null,e,null,i),this.width=5,this.height=5,this.targetPos={x:s.x-this.width/2,y:s.y},this.speed=.005*r.movementScale,this.t=0;const a=(this.pos.x+this.targetPos.x)/2,o=(this.pos.y+this.targetPos.y)/2;this.controlX=a,this.controlY=o-100}render(){this.ctx.fillStyle="grey",this.ctx.fillRect(this.pos.x,this.pos.y,this.width,this.height)}update(t){this.t+=t*this.speed,this.t>1.2&&(this.delete=!0),this.pos.x=(1-this.t)*(1-this.t)*this.ogPos.x+2*(1-this.t)*this.t*this.controlX+this.t*this.t*this.targetPos.x,this.pos.y=(1-this.t)*(1-this.t)*this.ogPos.y+2*(1-this.t)*this.t*this.controlY+this.t*this.t*this.targetPos.y,Math.sqrt((this.pos.x-this.ogPos.x)**2+(this.pos.y-this.ogPos.y)**2)>300&&(this.delete=!0)}}class Q extends T{constructor(t,e,s,i,a,o,l){super(t,e,s,i,a,o,l),this.pos=a,this.speed=1.2*r.movementScale,this.gravity=4*r.movementScale,this.jumpSpeed=4*r.movementScale,this.jumpChance=2,this.projectileEnemy=!0,this.aimo=7,this.projectile=[],this.lastShotElapsedTime=0}render(){this.ctx.fillStyle="lightblue",this.ctx.fillRect(this.pos.x,this.pos.y,this.width,this.height);for(let t=0;t<this.projectile.length;t++)this.projectile[t].render()}renderDev(){const t=(this.pos.x+this.width/2+this.player.pos.x+this.player.width/2)/2,e=(this.pos.y+this.player.pos.y)/2,s=t,i=e-100;this.ctx.save(),this.ctx.scale(r.canvasScale,r.canvasScale),this.ctx.translate(Math.round(-this.camera.pos.x),Math.round(-this.camera.pos.y)),this.ctx.strokeStyle="rgba(15, 255, 80, 0.5)",this.ctx.beginPath(),this.ctx.moveTo(this.pos.x+this.width/2,this.pos.y),this.ctx.quadraticCurveTo(s,i,this.player.pos.x+this.player.width/2,this.player.pos.y),this.ctx.stroke(),this.ctx.restore()}update(t,e){super.update(t),this.shoot(e);for(let s=0;s<this.projectile.length;s++)this.projectile[s].update(t),this.projectile[s].delete&&this.projectile.splice(s,1)}move(t){this.direction=="left"?this.vel.x=-this.speed:this.direction=="right"?this.vel.x=this.speed:this.vel.x=0,Math.floor(Math.random()*1e3)==999&&this.grounded&&this.vel.y===0&&(this.vel.y=-this.jumpSpeed,this.grounded=!1),this.pos.x+=this.vel.x*t}shoot(t){Math.floor(this.lastShotElapsedTime)+.5<=Math.floor(t)&&this.aimo>0&&(this.sound.play("sfx",2),this.projectile.push(new K(this.ctx,{x:this.pos.x+this.width/2,y:this.pos.y},{x:this.player.pos.x+this.player.width/2,y:this.player.pos.y},this.projectile.length)),this.lastShotElapsedTime=t,this.aimo--),this.aimo==0&&Math.floor(this.lastShotElapsedTime)+3<=Math.floor(t)&&(this.aimo=5)}collisionOnY(){let t=!1;for(let e=0;e<this.map.length;e++){for(let s=0;s<this.map[e].length;s++){let i=this.map[e][s];if(i.collision&&u(this,i)){if(this.vel.y>0){this.vel.y=0,this.pos.y=i.pos.y-this.height-.01,this.grounded=!0,t=!0;break}if(this.vel.y<0){this.vel.y=0,this.pos.y=i.pos.y+i.height+.01,t=!0;break}}}if(t)break}this.pos.y+this.height>=this.ctx.canvas.height&&(this.vel.y=0,this.pos.y=this.ctx.canvas.height-this.height,this.grounded=!0)}keyUpInput(t){t==="x"&&this.shoot()}}class Z{constructor(){this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.buffers={music:{},sfx:{}},this.currentMusicSource=null,this.currentMusicIndex=null,this.musicGainNode=this.audioContext.createGain(),this.sfxGainNode=this.audioContext.createGain(),this.musicGainNode.connect(this.audioContext.destination),this.sfxGainNode.connect(this.audioContext.destination),this.soundURL={music:["./resources/plat3/music/bongSong.wav"],sfx:["./resources/plat3/sfx/enemyDeath.wav","./resources/plat3/sfx/projectile/projectile.wav","./resources/plat3/sfx/projectile/canon.wav"]},this.loadAllSounds()}async loadAllSounds(){const t=[];for(const[e,s]of Object.entries(this.soundURL))s.forEach((i,a)=>{t.push(this.loadSound(i,e,a))});await Promise.all(t)}async loadSound(t,e,s){try{const a=await(await fetch(t)).arrayBuffer(),o=await this.audioContext.decodeAudioData(a);this.buffers[e][s]=o}catch(i){console.error(`Error loading sound: ${t}`,i)}}playSound(t,e,s=!1){const i=this.audioContext.createBufferSource();return i.buffer=t,i.loop=s,i.connect(e),i.start(0),i}play(t,e){const s=this.buffers[t][e];s&&(t==="music"?(this.currentMusicSource&&this.currentMusicSource.stop(),this.currentMusicSource=this.playSound(s,this.musicGainNode,!0),this.currentMusicIndex=e):t==="sfx"&&this.playSound(s,this.sfxGainNode,!1))}stop(t){t==="music"&&this.currentMusicSource&&(this.currentMusicSource.stop(),this.currentMusicSource=null,this.currentMusicIndex=null)}setVolume(t,e){t==="music"?this.musicGainNode.gain.setValueAtTime(e,this.audioContext.currentTime):t==="sfx"&&this.sfxGainNode.gain.setValueAtTime(e,this.audioContext.currentTime)}getVolume(t){if(t==="music")return this.musicGainNode.gain.value;if(t==="sfx")return this.sfxGainNode.gain.value}getCurrentMusic(){return this.currentMusicIndex}}const x=document.getElementById("gameCanvas"),n=x.getContext("2d");n.imageSmoothingEnabled=!1;n.canvas.width=screen.availWidth*.8;n.canvas.height=screen.availHeight*.7;var v=new Z;n.canvas.style="background-color: rgb(225, 171, 84);";var y="play",g=new $(n),f=new H(n,g),p=new F(n,f.map),c=[];for(let h=0;h<10;h++)c.push(new P(n,f.map,g,p,v,h));c.push(new Q(n,f.map,g,p,{x:1237,y:470},v,c.length));c.push(new T(n,f.map,g,p,{x:1237,y:470},v,c.length));var S=new Y(n,p,g,c,y,v);g.setTarget(p);let B=0,M=0;function z(h){const t=(h-M)/1e3;M=h,_(t),tt(),requestAnimationFrame(z)}function _(h){if(y=="play"&&p.alive){B+=h;for(let t=0;t<c.length;t++)c[t].update(h,B),c[t].shouldDelete&&c.splice(t,1);p.update(h,c),f.update(),g.update()}S.update(y),!p.alive||y=="pause"?v.stop("music"):v.getCurrentMusic()!=0&&v.play("music",0)}function tt(){n.clearRect(0,0,x.width,x.height),n.save(),n.scale(r.canvasScale,r.canvasScale),n.translate(Math.round(-g.pos.x),Math.round(-g.pos.y)),n.clearRect(0,0,x.width/r.canvasScale,x.height/r.canvasScale),f.render();for(let h=0;h<c.length;h++)c[h].render();p.render(),n.restore(),S.render(),et()}function et(){const h=Math.floor(B);n.save(),n.fillStyle="white",n.font="20px Arial",n.fillText("Time: "+h.toString().padStart(2,"0"),10,30),n.restore()}document.getElementById("runButton").addEventListener("click",function(){M=performance.now(),v.play("music",0),p.pos={x:0,y:0},requestAnimationFrame(z),this.disabled=!0});x.addEventListener("keydown",function(h){h.preventDefault(),h.key==="p"&&g.setTarget(p),h.key==="b"&&g.setTarget(f.map[199][0]),h.key==="Escape"&&(y==="play"?y="pause":(y="play",S.pauseState="none")),h.key==="r"&&(M=performance.now(),v.play("music",0),p.pos={x:0,y:0},f.setlevel("level1"),requestAnimationFrame(z),this.disabled=!0),h.key==="0"&&f.setlevel("level"),h.key==="1"&&f.setlevel("level1"),f.keyDownInput(h.key),p.keyDownInput(h.key),S.keyDownInput(h.key)});x.addEventListener("keyup",function(h){h.preventDefault(),p.keyUpInput(h.key);for(let t=0;t<c.length;t++)c[t].projectileEnemy&&c[t].keyUpInput(h.key)});x.addEventListener("click",function(h){h.preventDefault(),S.onClickInput(h),S.pauseState=="change to play"&&(y="play")},!1);
